<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta name="_csrf" th:attr="content=${_csrf.token}"/>
    <meta name="_csrf_header" th:attr="content=${_csrf.headerName}"/>

    <title>Food Tracker</title>
    <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
            rel="stylesheet">
    <style>
        .card:hover {
            transform: translateY(-5px);
            transition: .3s;
        }

        .clickable {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container py-4">

    <!-- Header -->
    <header class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-5">Food Tracker</h1>
        <form th:action="@{/logout}" method="post">
            <button class="btn btn-outline-danger">Sign Out</button>
        </form>
    </header>

    <!-- Search Input -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="input-group">
                <input class="form-control" id="productQuery" placeholder="Search grocery product…">
                <button class="btn btn-success" id="searchProductBtn">Search</button>
            </div>
        </div>
    </div>

    <!-- Results + Details Panels -->
    <div class="row">
        <!-- Search Results -->
        <div class="col-md-6">
            <h4>Results</h4>
            <div class="row gy-3" id="productResults">
                <!-- Injected by JS -->
            </div>
        </div>

        <!-- Nutrition Details -->
        <div class="col-md-6">
            <h4>Nutrition Details</h4>
            <div id="productDetails">
                <p class="text-muted">Click a product to see nutrition info.</p>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="text-center my-4" id="loadingIndicator" style="display:none;">
        <div class="spinner-border text-primary" role="status"></div>
        <div>Loading…</div>
    </div>

    <!-- Meal‑selection Modal -->
    <div class="modal fade" id="mealModal" tabindex="-1">
        <div class="modal-dialog">
            <form class="modal-content" id="mealForm">
                <div class="modal-header">
                    <h5 class="modal-title">Add to meal</h5>
                    <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    <input id="mealFdcId" name="fdcId" type="hidden">
                    <div class="form-check">
                        <input checked class="form-check-input" id="breakfast" name="mealType" type="radio"
                               value="BREAKFAST">
                        <label class="form-check-label" for="breakfast">Breakfast</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" id="lunch" name="mealType" type="radio" value="LUNCH">
                        <label class="form-check-label" for="lunch">Lunch</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" id="dinner" name="mealType" type="radio" value="DINNER">
                        <label class="form-check-label" for="dinner">Dinner</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" id="snack" name="mealType" type="radio" value="SNACK">
                        <label class="form-check-label" for="snack">Snack</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" type="submit">Add</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="mt-5 text-center text-muted">&copy; 2025 Food Tracker</footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const loading = document.getElementById('loadingIndicator');
        const results = document.getElementById('productResults');
        const details = document.getElementById('productDetails');
        const btn = document.getElementById('searchProductBtn');
        const query = document.getElementById('productQuery');
        const modalEl = document.getElementById('mealModal');
        const mealForm = document.getElementById('mealForm');
        const mealIdIn = document.getElementById('mealFdcId');
        const bsModal = new bootstrap.Modal(modalEl);

        // Search products
        btn.addEventListener('click', () => {
            const q = query.value.trim();
            if (!q) return;
            results.innerHTML = '';
            details.innerHTML = '';
            loading.style.display = 'block';

            fetch(`/searchProduct?query=${encodeURIComponent(q)}`)
                .then(r => r.json())
                .then(data => {
                    loading.style.display = 'none';
                    if (!data.products || !data.products.length) {
                        results.innerHTML = `<div class="alert alert-info">No products found.</div>`;
                        return;
                    }
                    data.products.forEach(p => {
                        const col = document.createElement('div');
                        col.className = 'col-12';
                        col.innerHTML = `
            <div class="card p-2">
              <div class="d-flex justify-content-between align-items-center">
                <div class="clickable flex-grow-1" data-id="${p.id}">
                  <h5 class="mb-1">${p.title}</h5>
                  <p class="mb-0"><small class="text-muted">${p.brand || 'Brand: N/A'}</small></p>
                </div>
                <button class="btn btn-outline-primary btn-sm add-btn" data-id="${p.id}">
                  Add
                </button>
              </div>
            </div>`;
                        results.appendChild(col);
                    });

                    // attach handlers
                    document.querySelectorAll('.clickable').forEach(el =>
                        el.addEventListener('click', () => loadDetails(el.dataset.id))
                    );
                    document.querySelectorAll('.add-btn').forEach(el =>
                        el.addEventListener('click', () => {
                            mealIdIn.value = el.dataset.id;
                            mealForm.querySelectorAll('.alert').forEach(a => a.remove());
                            bsModal.show();
                        })
                    );
                })
                .catch(err => {
                    loading.style.display = 'none';
                    results.innerHTML = `<div class="alert alert-danger">Search error.</div>`;
                    console.error(err);
                });
        });

        // Load nutrition details
        function loadDetails(fdcId) {
            details.innerHTML = '';
            loading.style.display = 'block';

            fetch(`/getNutrition?fdcId=${fdcId}`)
                .then(r => r.json())
                .then(n => {
                    loading.style.display = 'none';
                    const getNutr = key => {
                        const entry = n.foodNutrients.find(x => x.nutrient.name === key);
                        return entry ? `${entry.amount} ${entry.nutrient.unitName}` : 'n/a';
                    };
                    details.innerHTML = `
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">${n.description}</h5>
              <p><strong>Brand:</strong> ${n.brandOwner || 'N/A'}</p>
              <p><strong>Serving:</strong> ${n.servingSize || 100} ${n.servingSizeUnit || 'g'}</p>
              <ul class="list-unstyled mt-3">
                <li>Calories: ${getNutr('Energy')}</li>
                <li>Protein: ${getNutr('Protein')}</li>
                <li>Fat: ${getNutr('Total lipid (fat)')}</li>
                <li>Carbs: ${getNutr('Carbohydrate, by difference')}</li>
                <li>Fiber: ${getNutr('Fiber, total dietary')}</li>
                <li>Sugars: ${getNutr('Sugars, total')}</li>
                <li>Sodium: ${getNutr('Sodium, Na')}</li>
              </ul>
            </div>
          </div>`;
                })
                .catch(err => {
                    loading.style.display = 'none';
                    details.innerHTML = `<div class="alert alert-danger">Failed to load nutrition details.</div>`;
                    console.error(err);
                });
        }

        // Handle “Add to meal” via AJAX
        mealForm.addEventListener('submit', e => {
            e.preventDefault();
            const payload = {
                fdcId: Number(mealIdIn.value),
                mealType: mealForm.mealType.value
            };

            // Grab the header name and token from your meta tags
            const csrfHeader = document
                .querySelector('meta[name="_csrf_header"]')
                .getAttribute('content');
            const csrfToken = document
                .querySelector('meta[name="_csrf"]')
                .getAttribute('content');

            fetch('/api/log', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(payload)
            })
                .then(res => {
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                })
                .then(json => {
                    const msg = document.createElement('div');
                    msg.className = 'alert alert-success';
                    msg.textContent = `Added entry`;
                    mealForm.prepend(msg);
                })
                .catch(err => {
                    const msg = document.createElement('div');
                    msg.className = 'alert alert-danger';
                    msg.textContent = 'Failed to add. Try again.';
                    mealForm.prepend(msg);
                    console.error(err);
                });
        });
    });
</script>
</body>
</html>
